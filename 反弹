local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

local maxTriggers = 10
local triggers = 0
local lastHealth = humanoid.Health

humanoid:GetPropertyChangedSignal("Health"):Connect(function()
    local currentHealth = humanoid.Health
    if currentHealth < lastHealth and currentHealth / humanoid.MaxHealth <= 0.2 and triggers < maxTriggers then
        triggers = triggers + 1
        local closestNPC = nil
        local closestDistance = math.huge
        for _, npc in pairs(Workspace:WaitForChild("Enemies"):GetChildren()) do
            if npc:FindFirstChild("HumanoidRootPart") then
                local distance = (rootPart.Position - npc.HumanoidRootPart.Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestNPC = npc
                end
            end
        end
        if closestNPC then
            local args = {
                closestNPC:WaitForChild("HumanoidRootPart"),
                "Melee",
                {
                    dismantle = false,
                    riposte = false,
                    backstab = true
                }
            }
            ReplicatedStorage:WaitForChild("OnServerEvents"):WaitForChild("CombatServer"):FireServer(unpack(args))
        end
    end
    lastHealth = currentHealth
end)
