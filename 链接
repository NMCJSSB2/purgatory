local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")

local lastHealth = humanoid.Health
local triggered = false

humanoid:GetPropertyChangedSignal("Health"):Connect(function()
    local currentHealth = humanoid.Health
    if not triggered and currentHealth < lastHealth and currentHealth / humanoid.MaxHealth <= 0.1 then
        triggered = true
        for i = 1, 20 do
            for _, npc in pairs(Workspace:WaitForChild("Enemies"):GetChildren()) do
                if npc:FindFirstChild("HumanoidRootPart") then
                    local args = {
                        npc:WaitForChild("HumanoidRootPart"),
                        "Melee",
                        {
                            dismantle = true,
                            riposte = true,
                            backstab = true
                        }
                    }
                    ReplicatedStorage:WaitForChild("OnServerEvents"):WaitForChild("CombatServer"):FireServer(unpack(args))
                end
            end
        end
    end
    lastHealth = currentHealth
end)
